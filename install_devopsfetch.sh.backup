#!/bin/bash

# Function to install necessary dependencies
install_dependencies() {
    echo "Installing necessary dependencies..."
    sudo apt-get update
    sudo apt-get install -y nginx docker.io jq net-tools


    # Ensure Docker is started
    sudo systemctl start docker
    sudo systemctl enable docker

    # Create log directory
    sudo mkdir -p /var/log/devopsfetch
}

# Function to create the systemd service
create_systemd_service() {
    echo "Creating systemd service..."

    cat <<EOF | sudo tee /etc/systemd/system/devopsfetch.service
[Unit]
Description=DevOps Fetch Service
After=network.target

[Service]
ExecStart=/usr/local/bin/devopsfetch_monitor.sh
Restart=always

[Timer]
OnBootSec=1min
OnUnitActiveSec=1min
Unit=devopsfetch.service

[Install]
WantedBy=multi-user.target
EOF

    sudo systemctl daemon-reload
    sudo systemctl enable devopsfetch.service
    sudo systemctl start devopsfetch.service
}

# Function to create the monitoring script
create_monitoring_script() {
    echo "Creating monitoring script..."

    cat <<'EOF' | sudo tee /usr/local/bin/devopsfetch_monitor.sh
#!/bin/bash

LOG_FILE="/var/log/devopsfetch/devopsfetch.log"

while true; do
    {
        echo "Timestamp: $(date)"
        echo "Active Ports:"
        sudo netstat -tuln
        echo "User Logins:"
        last
        echo "Nginx Configuration:"
        sudo nginx -T
        echo "Docker Images:"
        sudo docker images
        echo "Docker Containers:"
        sudo docker ps -a
    } >> $LOG_FILE

    sleep 2  # Adjust the sleep time as needed
done
EOF

    sudo chmod +x /usr/local/bin/devopsfetch_monitor.sh
}

# Function to set up log rotation
setup_log_rotation() {
    echo "Setting up log rotation..."

    cat <<EOF | sudo tee /etc/logrotate.d/devopsfetch
/var/log/devopsfetch/devopsfetch.log {
    daily
    rotate 7
    compress
    missingok
    notifempty
    create 0640 root root
    sharedscripts
    postrotate
        systemctl restart devopsfetch.service > /dev/null
    endscript
}
EOF
}

install_dependencies
create_monitoring_script
create_systemd_service
setup_log_rotation

echo "Setup complete. The devopsfetch service is now monitoring your system."
